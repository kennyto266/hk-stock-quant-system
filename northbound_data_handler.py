#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\"\"\"\nåŒ—æ°´æ•¸æ“šè™•ç†å™¨\nç”¨æ–¼è§£æJSONæ•¸æ“šä¸¦è¨ˆç®—æŠ€è¡“æŒ‡æ¨™\n\"\"\"\n\nimport json\nimport pandas as pd\nimport numpy as np\nfrom datetime import datetime\nimport os\nfrom typing import Dict, List, Optional\n\nclass NorthboundDataHandler:\n    \"\"\"åŒ—æ°´æ•¸æ“šè™•ç†å™¨\"\"\"\n    \n    def __init__(self, json_folder_path: str = \"../åŒ—æ°´json\"):\n        self.json_folder_path = json_folder_path\n        self.raw_data = []\n        self.processed_data = None\n        \n    def load_json_files(self) -> List[Dict]:\n        \"\"\"è¼‰å…¥æ‰€æœ‰JSONæ–‡ä»¶\"\"\"\n        json_files = []\n        \n        if not os.path.exists(self.json_folder_path):\n            print(f\"âŒ æ‰¾ä¸åˆ°åŒ—æ°´æ•¸æ“šç›®éŒ„: {self.json_folder_path}\")\n            return json_files\n        \n        for filename in sorted(os.listdir(self.json_folder_path)):\n            if filename.endswith('.json'):\n                file_path = os.path.join(self.json_folder_path, filename)\n                try:\n                    with open(file_path, 'r', encoding='utf-8') as f:\n                        data = json.load(f)\n                        json_files.append(data)\n                        print(f\"âœ… è¼‰å…¥: {filename}\")\n                except Exception as e:\n                    print(f\"âŒ è¼‰å…¥å¤±æ•— {filename}: {e}\")\n        \n        print(f\"ğŸ“Š ç¸½å…±è¼‰å…¥ {len(json_files)} å€‹JSONæ–‡ä»¶\")\n        return json_files\n    \n    def parse_northbound_data(self, raw_data: List[Dict]) -> pd.DataFrame:\n        \"\"\"è§£æåŒ—æ°´æ•¸æ“š\"\"\"\n        parsed_records = []\n        \n        for daily_data in raw_data:\n            if not isinstance(daily_data, list):\n                continue\n                \n            for market_data in daily_data:\n                date = market_data.get('date', '')\n                market = market_data.get('market', '')\n                \n                if not date or not market:\n                    continue\n                \n                # è§£æäº¤æ˜“æ•¸æ“š\n                content = market_data.get('content', [])\n                for item in content:\n                    if item.get('style') == 1:  # ç¸½é«”æ•¸æ“š\n                        table = item.get('table', {})\n                        tr_data = table.get('tr', [])\n                        \n                        if tr_data:\n                            try:\n                                # æå–ç¸½æˆäº¤é¡\n                                total_turnover = 0\n                                if len(tr_data) > 0:\n                                    turnover_str = tr_data[0]['td'][0][0].replace(',', '')\n                                    total_turnover = float(turnover_str)\n                                \n                                # æå–äº¤æ˜“ç­†æ•¸\n                                trade_count = 0\n                                if len(tr_data) > 1:\n                                    count_str = tr_data[1]['td'][0][0].replace(',', '')\n                                    trade_count = int(count_str)\n                                \n                                parsed_records.append({\n                                    'Date': pd.to_datetime(date),\n                                    'Market': market,\n                                    'Total_Turnover': total_turnover,\n                                    'Trade_Count': trade_count\n                                })\n                                \n                            except (IndexError, ValueError, KeyError) as e:\n                                print(f\"âš ï¸ è§£æéŒ¯èª¤ {date} {market}: {e}\")\n        \n        if not parsed_records:\n            print(\"âŒ æ²’æœ‰è§£æåˆ°æœ‰æ•ˆæ•¸æ“š\")\n            return pd.DataFrame()\n        \n        df = pd.DataFrame(parsed_records)\n        print(f\"âœ… è§£æå®Œæˆï¼Œå…± {len(df)} æ¢è¨˜éŒ„\")\n        return df\n    \n    def aggregate_daily_data(self, df: pd.DataFrame) -> pd.DataFrame:\n        \"\"\"èšåˆæ¯æ—¥æ•¸æ“š\"\"\"\n        if df.empty:\n            return df\n        \n        # æŒ‰æ—¥æœŸèšåˆæ‰€æœ‰å¸‚å ´çš„æ•¸æ“š\n        daily_agg = df.groupby('Date').agg({\n            'Total_Turnover': 'sum',\n            'Trade_Count': 'sum'\n        }).reset_index()\n        \n        # æ’åº\n        daily_agg = daily_agg.sort_values('Date').reset_index(drop=True)\n        \n        print(f\"ğŸ“Š èšåˆå¾Œæ•¸æ“šç¯„åœ: {daily_agg['Date'].min()} åˆ° {daily_agg['Date'].max()}\")\n        return daily_agg\n    \n    def calculate_technical_indicators(self, df: pd.DataFrame) -> pd.DataFrame:\n        \"\"\"åŸºæ–¼åŒ—æ°´æ•¸æ“šè¨ˆç®—æŠ€è¡“æŒ‡æ¨™\"\"\"\n        if df.empty:\n            return df\n        \n        df = df.copy()\n        \n        # æˆäº¤é¡ä½œç‚º\"åƒ¹æ ¼\"æ•¸æ“š\n        df['Price'] = df['Total_Turnover']\n        df['Volume'] = df['Trade_Count']\n        \n        # è¨ˆç®—ç§»å‹•å¹³å‡\n        df['MA_5'] = df['Price'].rolling(window=5).mean()\n        df['MA_10'] = df['Price'].rolling(window=10).mean()\n        df['MA_20'] = df['Price'].rolling(window=20).mean()\n        \n        # è¨ˆç®—RSI (åŸºæ–¼æˆäº¤é¡è®ŠåŒ–)\n        def calculate_rsi(prices, period=14):\n            delta = prices.diff()\n            gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()\n            loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()\n            rs = gain / loss\n            rsi = 100 - (100 / (1 + rs))\n            return rsi\n        \n        df['RSI'] = calculate_rsi(df['Price'])\n        \n        # è¨ˆç®—MACD\n        exp1 = df['Price'].ewm(span=12).mean()\n        exp2 = df['Price'].ewm(span=26).mean()\n        df['MACD'] = exp1 - exp2\n        df['MACD_Signal'] = df['MACD'].ewm(span=9).mean()\n        df['MACD_Histogram'] = df['MACD'] - df['MACD_Signal']\n        \n        # è¨ˆç®—å¸ƒæ—å¸¶\n        df['BB_Middle'] = df['Price'].rolling(window=20).mean()\n        bb_std = df['Price'].rolling(window=20).std()\n        df['BB_Upper'] = df['BB_Middle'] + (bb_std * 2)\n        df['BB_Lower'] = df['BB_Middle'] - (bb_std * 2)\n        \n        # è¨ˆç®—æˆäº¤é¡è®ŠåŒ–ç‡\n        df['Turnover_Change'] = df['Price'].pct_change()\n        df['Volume_Change'] = df['Volume'].pct_change()\n        \n        print(f\"âœ… æŠ€è¡“æŒ‡æ¨™è¨ˆç®—å®Œæˆ\")\n        return df\n    \n    def process_all_data(self) -> pd.DataFrame:\n        \"\"\"è™•ç†æ‰€æœ‰æ•¸æ“šçš„ä¸»å‡½æ•¸\"\"\"\n        print(\"ğŸ”„ é–‹å§‹è™•ç†åŒ—æ°´æ•¸æ“š...\")\n        \n        # 1. è¼‰å…¥JSONæ–‡ä»¶\n        raw_data = self.load_json_files()\n        if not raw_data:\n            return pd.DataFrame()\n        \n        # 2. è§£ææ•¸æ“š\n        parsed_df = self.parse_northbound_data(raw_data)\n        if parsed_df.empty:\n            return pd.DataFrame()\n        \n        # 3. èšåˆæ¯æ—¥æ•¸æ“š\n        daily_df = self.aggregate_daily_data(parsed_df)\n        if daily_df.empty:\n            return daily_df\n        \n        # 4. è¨ˆç®—æŠ€è¡“æŒ‡æ¨™\n        final_df = self.calculate_technical_indicators(daily_df)\n        \n        # 5. ä¿å­˜è™•ç†å¾Œçš„æ•¸æ“š\n        self.processed_data = final_df\n        \n        # 6. ä¿å­˜åˆ°CSV\n        output_path = \"data_output/csv/northbound_processed_data.csv\"\n        os.makedirs(os.path.dirname(output_path), exist_ok=True)\n        final_df.to_csv(output_path, index=False, encoding='utf-8-sig')\n        print(f\"ğŸ’¾ æ•¸æ“šå·²ä¿å­˜åˆ°: {output_path}\")\n        \n        return final_df\n    \n    def get_stock_proxy_data(self, symbol=\"2800.HK\") -> pd.DataFrame:\n        \"\"\"åŸºæ–¼åŒ—æ°´æ•¸æ“šç”Ÿæˆè‚¡ç¥¨ä»£ç†æ•¸æ“š\"\"\"\n        if self.processed_data is None or self.processed_data.empty:\n            print(\"âŒ æ²’æœ‰è™•ç†å¾Œçš„åŒ—æ°´æ•¸æ“š\")\n            return pd.DataFrame()\n        \n        df = self.processed_data.copy()\n        \n        # ç”ŸæˆOHLCæ•¸æ“šï¼ˆåŸºæ–¼æˆäº¤é¡ï¼‰\n        base_price = 100  # åŸºæº–åƒ¹æ ¼\n        \n        # ä½¿ç”¨æˆäº¤é¡è®ŠåŒ–ä¾†æ¨¡æ“¬åƒ¹æ ¼è®ŠåŒ–\n        price_changes = df['Turnover_Change'].fillna(0)\n        \n        # è¨ˆç®—ç´¯ç©åƒ¹æ ¼\n        df['Close'] = base_price * (1 + price_changes).cumprod()\n        \n        # ç”ŸæˆOpen, High, Low\n        df['Open'] = df['Close'].shift(1).fillna(base_price)\n        \n        # ä½¿ç”¨æ—¥å…§æ³¢å‹•ç‡ç”ŸæˆHighå’ŒLow\n        daily_volatility = abs(price_changes) * 2\n        df['High'] = df['Close'] * (1 + daily_volatility)\n        df['Low'] = df['Close'] * (1 - daily_volatility)\n        \n        # ç¢ºä¿High >= Close >= Low å’Œ High >= Open >= Low\n        df['High'] = df[['High', 'Close', 'Open']].max(axis=1)\n        df['Low'] = df[['Low', 'Close', 'Open']].min(axis=1)\n        \n        # é‡æ–°æ’åˆ—åˆ—\n        stock_data = df[['Date', 'Open', 'High', 'Low', 'Close', 'Volume']].copy()\n        stock_data.set_index('Date', inplace=True)\n        \n        print(f\"âœ… ç”Ÿæˆè‚¡ç¥¨ä»£ç†æ•¸æ“š: {len(stock_data)} æ¢è¨˜éŒ„\")\n        print(f\"ğŸ“Š åƒ¹æ ¼ç¯„åœ: {stock_data['Close'].min():.2f} - {stock_data['Close'].max():.2f}\")\n        \n        return stock_data\n\n# æ¸¬è©¦å‡½æ•¸\nif __name__ == \"__main__\":\n    handler = NorthboundDataHandler()\n    processed_data = handler.process_all_data()\n    \n    if not processed_data.empty:\n        print(\"\\nğŸ“Š æ•¸æ“šæ¦‚è¦½:\")\n        print(processed_data.head())\n        print(f\"\\nğŸ“ˆ æ•¸æ“šçµ±è¨ˆ:\")\n        print(processed_data.describe())\n        \n        # ç”Ÿæˆè‚¡ç¥¨ä»£ç†æ•¸æ“š\n        stock_data = handler.get_stock_proxy_data()\n        if not stock_data.empty:\n            print(\"\\nğŸ¢ è‚¡ç¥¨ä»£ç†æ•¸æ“š:\")\n            print(stock_data.head()) 